<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fa Editor</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: sans-serif;
    }

    header {
      background: #222;
      color: #fff;
      padding: 0.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    header button {
      background: #444;
      color: #fff;
      border: none;
      padding: 0.5em 1em;
      cursor: pointer;
      border-radius: 4px;
    }

    header button:hover {
      background: #666;
    }

    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #tabs {
      display: flex;
      background: #333;
      color: #fff;
      padding: 0.25em;
      overflow-x: auto;
    }

    #tabs div {
      padding: 0.5em 1em;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      background: #444;
      margin-right: 4px;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }

    #tabs div.active {
      background: #007acc;
    }

    #tabs .close {
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #ff6666;
    }

    #tabs .close:hover {
      color: red;
    }

    #editor {
      flex: 1;
      min-height: 0;
    }
  </style>

  <!-- Monaco Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>

<body>
  <header>
    <img src="favicon.png" height="40" width="40" class="logo">
    <button onclick="newFile()">üìÑ New File</button>
    <button onclick="renameFile()">üìù Rename File</button>
    <button onclick="openProject()">üìÇ Open</button>
    <button onclick="copyCode()">üìã Copy</button>
    <button onclick="downloadZip()">üíæ Download ZIP</button>
    <button onclick="toggleWordWrap()">‚ÜîÔ∏è Word Wrap</button>
    <button onclick="formatDocument()">‚ú® Format</button>
  </header>

  <div id="container">
    <div id="tabs"></div>
    <div id="editor"></div>
  </div>

  <script>
    let editor;
    let models = {};
    let currentFile = null;
    let wordWrapEnabled = false;

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: "<!--Fa editor-->",
        language: "html",
        theme: "vs-dark",
        automaticLayout: true,
        minimap: { enabled: true },
        wordWrap: "off"
      });
      restoreSession();
    });

    function getLanguageFromExtension(filename) {
      if (filename.endsWith(".html")) return "html";
      if (filename.endsWith(".css")) return "css";
      if (filename.endsWith(".js")) return "javascript";
      if (filename.endsWith(".txt")) return "plaintext";
      return "plaintext";
    }

    function newFile() {
      let filename = prompt("Enter new file name (with extension .html, .css, .js, .txt):");
      if (!filename) return;
      if (models[filename]) {
        alert("File already exists!");
        return;
      }
      const lang = getLanguageFromExtension(filename);
      const model = monaco.editor.createModel("", lang);
      models[filename] = model;
      models[filename].closed = false;
      switchFile(filename);
      saveSession();
    }

    function renameFile() {
      if (!currentFile) {
        alert("No file selected!");
        return;
      }
      let newName = prompt("Enter new filename:", currentFile);
      if (!newName) return;
      if (models[newName]) {
        alert("A file with that name already exists!");
        return;
      }
      models[newName] = models[currentFile];
      delete models[currentFile];
      currentFile = newName;
      refreshTabs();
      saveSession();
    }

    function openProject() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".zip,.html,.css,.js,.txt";
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.match(/\.(html|css|js|txt)$/)) {
          const text = await file.text();
          openFile(file.name, text);
          return;
        }

        const data = await file.arrayBuffer();
        JSZip.loadAsync(data).then(zip => {
          zip.forEach((relPath, file) => {
            if (file.name.match(/\.(html|css|js|txt)$/)) {
              file.async("string").then(content => {
                openFile(file.name, content);
              });
            }
          });
        });
      };
      input.click();
    }

    function openFile(name, content) {
      const lang = getLanguageFromExtension(name);

      if (models[name]) {
        models[name].closed = false;
        switchFile(name);
        return;
      }

      const model = monaco.editor.createModel(content, lang);
      models[name] = model;
      models[name].closed = false;
      switchFile(name);
      saveSession();
    }

    function switchFile(name) {
      currentFile = name;
      editor.setModel(models[name]);
      refreshTabs();
      saveSession();
    }

    function closeFile(name) {
      if (!models[name]) return;
      models[name].closed = true;

      if (currentFile === name) {
        const remaining = Object.keys(models).filter(f => !models[f].closed);
        if (remaining.length > 0) {
          switchFile(remaining[0]);
        } else {
          editor.setValue("<!--Fa editor-->");
          editor.setModel(null);
          currentFile = null;
        }
      }
      refreshTabs();
      saveSession();
    }

    function refreshTabs() {
      const tabs = document.getElementById("tabs");
      tabs.innerHTML = "";
      Object.keys(models).forEach(filename => {
        if (models[filename].closed) return;

        const tab = document.createElement("div");
        if (filename === currentFile) tab.classList.add("active");

        const nameSpan = document.createElement("span");
        nameSpan.textContent = filename;
        tab.appendChild(nameSpan);

        const closeBtn = document.createElement("span");
        closeBtn.textContent = " √ó";
        closeBtn.classList.add("close");
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeFile(filename);
        };
        tab.appendChild(closeBtn);

        tab.onclick = () => switchFile(filename);
        tabs.appendChild(tab);
      });
    }

    function copyCode() {
      if (!currentFile) {
        alert("No file open!");
        return;
      }
      const code = editor.getValue();
      navigator.clipboard.writeText(code).then(() => {
        alert(currentFile + " copied to clipboard!");
      });
    }

    async function downloadZip() {
      const zip = new JSZip();
      Object.keys(models).forEach(name => {
        const code = models[name].getValue();
        zip.file(name, code);
      });
      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "project.zip";
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function toggleWordWrap() {
      wordWrapEnabled = !wordWrapEnabled;
      editor.updateOptions({ wordWrap: wordWrapEnabled ? "on" : "off" });
    }

    function formatDocument() {
      if (!currentFile) {
        alert("No file open!");
        return;
      }
      editor.getAction("editor.action.formatDocument").run();
    }

    function saveSession() {
      const session = {
        files: {},
        currentFile
      };
      Object.keys(models).forEach(name => {
        session.files[name] = {
          content: models[name].getValue(),
          closed: models[name].closed || false
        };
      });
      localStorage.setItem("fa-editor-session", JSON.stringify(session));
    }

    function restoreSession() {
      const sessionData = localStorage.getItem("fa-editor-session");
      if (!sessionData) return;

      try {
        const session = JSON.parse(sessionData);
        Object.keys(session.files).forEach(name => {
          const file = session.files[name];
          const model = monaco.editor.createModel(file.content, getLanguageFromExtension(name));
          model.closed = file.closed;
          models[name] = model;
        });

        if (session.currentFile && models[session.currentFile]) {
          switchFile(session.currentFile);
        } else {
          const openFiles = Object.keys(models).filter(f => !models[f].closed);
          if (openFiles.length > 0) switchFile(openFiles[0]);
        }
        refreshTabs();
      } catch (e) {
        console.error("Failed to restore session:", e);
      }
    }
  </script>
</body>
</html>

