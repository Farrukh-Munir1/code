<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fa Editor</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: sans-serif;
    }

    header {
      background: #222;
      color: #fff;
      padding: 0.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    header button {
      background: #444;
      color: #fff;
      border: none;
      padding: 0.5em 1em;
      cursor: pointer;
      border-radius: 4px;
    }

    header button:hover {
      background: #666;
    }

    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #tabs {
      display: flex;
      background: #333;
      color: #fff;
      padding: 0.25em;
      overflow-x: auto;
    }

    #tabs div {
      padding: 0.5em 1em;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      background: #444;
      margin-right: 4px;
      white-space: nowrap;
    }

    #tabs div {
      display: flex;
      align-items: center;
      padding: 0.5em 0.75em;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      background: #444;
      margin-right: 4px;
      white-space: nowrap;
    }


    #tabs div.active {
      background: #007acc;
    }

    #editor {
      flex: 1;
      min-height: 0;
    }
  </style>

  <!-- Monaco Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>

<body>
  <header>
    <img src="favicon.png" height="50" width="50" class="logo">
    <button onclick="openProject()">ðŸ“‚ Open</button>
    <button onclick="copyCode()">ðŸ“‹ Copy</button>
    <button onclick="downloadFile()">ðŸ’¾ Download</button>
  </header>

  <div id="container">
    <div id="tabs"></div>
    <div id="editor"></div>
  </div>

  <script>
    function refreshTabs() {
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";
  Object.keys(models).forEach(filename => {
    const tab = document.createElement("div");
    tab.classList.add("tab");

    // Filename
    const nameSpan = document.createElement("span");
    nameSpan.textContent = filename;
    nameSpan.onclick = () => switchFile(filename);

    // Close button
    const closeBtn = document.createElement("span");
    closeBtn.textContent = " Ã—";
    closeBtn.style.marginLeft = "6px";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = (e) => {
      e.stopPropagation(); // donâ€™t switch file when closing
      closeFile(filename);
    };

    if (filename === currentFile) tab.classList.add("active");

    tab.appendChild(nameSpan);
    tab.appendChild(closeBtn);
    tabs.appendChild(tab);
  });
}

function closeFile(name) {
  if (!models[name]) return;

  // Dispose Monaco model
  models[name].dispose();
  delete models[name];

  if (currentFile === name) {
    // pick another open file if available
    const remaining = Object.keys(models);
    if (remaining.length > 0) {
      switchFile(remaining[0]);
    } else {
      editor.setValue("<!--Fa editor-->");
      currentFile = null;
    }
  }

  refreshTabs();
}

    let editor;
    let models = {};
    let currentFile = null;

    // Load Monaco
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: "<!--Fa editor-->",
        language: "html",
        theme: "vs-dark",
        automaticLayout: true,
        minimap: { enabled: true },
      });
    });

    function getLanguageFromExtension(filename) {
      if (filename.endsWith(".html")) return "html";
      if (filename.endsWith(".css")) return "css";
      if (filename.endsWith(".js")) return "javascript";
      if (filename.endsWith(".txt")) return "plaintext";
      return "plaintext";
    }

    function openProject() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".zip,.html,.css,.js,.txt";
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.match(/\.(html|css|js|txt)$/)) {
          const text = await file.text();
          openFile(file.name, text);
          return;
        }

        const data = await file.arrayBuffer();
        JSZip.loadAsync(data).then(zip => {
          zip.forEach((relPath, file) => {
            if (file.name.match(/\.(html|css|js|txt)$/)) {
              file.async("string").then(content => {
                openFile(file.name, content);
              });
            }
          });
        });
      };
      input.click();
    }

    function openFile(name, content) {
      const lang = getLanguageFromExtension(name);

      if (models[name]) {
        switchFile(name);
        return;
      }

      const model = monaco.editor.createModel(content, lang);
      models[name] = model;
      currentFile = name;

      editor.setModel(model);
      refreshTabs();
    }

    function switchFile(name) {
      currentFile = name;
      editor.setModel(models[name]);
      refreshTabs();
    }

    function refreshTabs() {
      const tabs = document.getElementById("tabs");
      tabs.innerHTML = "";
      Object.keys(models).forEach(filename => {
        const tab = document.createElement("div");
        tab.textContent = filename;
        if (filename === currentFile) tab.classList.add("active");
        tab.onclick = () => switchFile(filename);
        tabs.appendChild(tab);
      });
    }

    function copyCode() {
      if (!currentFile) {
        alert("No file open!");
        return;
      }
      const code = editor.getValue();
      navigator.clipboard.writeText(code).then(() => {
        alert(currentFile + " copied to clipboard!");
      });
    }

    // âœ… Download as ZIP (default for TV Bro)
    async function downloadFile() {
      if (!Object.keys(models).length) {
        alert("No files open to download!");
        return;
      }

      const zip = new JSZip();
      Object.keys(models).forEach(name => {
        const code = models[name].getValue();
        zip.file(name, code);
      });

      const content = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(content);

      try {
        const link = document.createElement("a");
        link.href = url;
        link.download = "project.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (e) {
        window.open(url, "_blank"); // fallback
      }
    }
  </script>
</body>

</html>
